# Learning Spark   
## chapter 10. MLlib을 사용한 머신러닝   

우리는 머신러닝과 인공지능 프로그램이 필수적인 부분이 되는 시대를 살고 있다.   
인지하든 못하든 우리는 매일 온라인 쇼핑 추천 및 광고, 사기 탐지, 분류, 이미지 인식, 패턴 매칭 등을 하기 위해 ML 모델과 접촉하고 있다.   
맥킨지 연구에 따르면 소비자가 아마존에서 구매를 결정하는 것의 35%와 넷플릭스에서 시청하는 것의 75%는 머신러닝 기반 추천에 의해 좌우된다고 한다.   
즉, 좋은 성과를 내는 모델을 개발하는 것은 회사를 만들 수도 있고, 무너뜨릴 수도 있다.   

10장에서는 아파치 스파크의 머신러닝 라이브러리인 MLlib을 사용해서 ML 모델을 구축하는 방법에 대해 배워보겠다.   

## 머신러닝이란 무엇인가?   
머신러닝은 요즘 많은 과대 광고, 마케팅의 대상이 되고 있다. 그렇다면 머신러닝이란 정확히 무엇일까?   
일반적으로 머신러닝은 통계, 선형 대수 및 수치 최적화를 통해 데이터에서 패턴을 추출하는 프로세스다. 예를 들어 전력 소비 예측, 고양이 유무 결정, 유사한 특성의 상품끼리 클러스터링 같은 문제에 해당한다.   
먼저 머신러닝의 유형에 대해 알아보겠다.   

### 지도학습
레이블이 연결되어있는 데이터가 입력 레코드로 주어지며, 출력 레이블을 예측하는 유형에 해당한다.    
출력 레이블은 이산적이거나 연속적일 수 있으며, 분류와 회귀 두가지 방법을 가진다.   

- '있다/없다'와 같은 이진 레이블, 혹은 개의 품종과 같은 다항식 레이블로 예측하는 것은 분류에 해당한다.   
- 주어진 기온에 따라 일일 아이스크림 판매량을 예측하는 것과 같이 레이블이 아닌 연속된 숫자를 예측하는 것은 회귀에 해당한다.    

**인기있는 분류 및 회귀 알고리즘**   
- 선형 회귀 : 회귀 알고리즘   
- 로지스틱 회귀 : 분류 알고리즘   
- 의사결정나무 : 둘다   
- 그래디언트 부스트 트리 : 둘다   
- 랜덤 포레스트 : 둘다   
- 나이브 베이즈 : 분류   
- 서포트벡터머신 : 분류   


### 비지도학습   
이상값 감지 혹은 지도 머신러닝을 위한 전처리 단계로 사용한다. MLlib의 일부 비지도 머신러닝 알고리즘에는 k-means, latent dirichlet allocation (LDA) 및 가우시안 혼합 모델이 포함된다.   

**왜 머신러닝을 위한 스파크인가?**   
 
스파크는 데이터 수집, 피처 엔지니어링, 모델 교육 및 배포를 위한 에코시스템을 제공하는 통합 분석 엔진이다.    
개발자가 스파크 없이 이러한 일련의 작업을 수행하기 위해서는 여러 도구가 필요하고 확장성 문제는 여전히 어려움이 있다.   
스파크에는 spark.mllib와 spark.ml 	두가지 머신러닝 패키지가 있다.   
- spark.mllib은 RDD API를 기반으로 하는 기존의 머신러닝 API   
- spark.ml은 데이터 프레임을 기반으로 하는 최신 API   

이 장에서는 spark.ml 패키지를 사용할 것이다.   

spark.ml의 장점   
1. 데이터 과학자는 단일 시스템에 맞게 데이터를 다운샘플링할 필요 없이 데이터 준비 및 모델 구축을 하나의 에코시스템으로 사용할 수 있다.   
2. 모델이 보유한 데이터 포인트 수에 따라 선형으로 확장되는 O(n) 확장에 중점을 두어 방대한 양의 데이터로 확장할 수 있다.   
 
다음 장에서 spark.ml과 같은 분산 프레임워크와 사이킷런과 같은 단일 노드 프레임워크 사이에서 선택하는 것과관련된 몇 가지 절충안에 대해 살펴보겠다.   

## 머신러닝 파이프라인 설계
파이프라인이란? 데이터에 적용할 일련의 작업을 구성하는 일반적인 방법   
MLlib에서 파이프라인 API는 머신러닝 워크플로를 구성하기 위해 데이터 프레임 위헤 구축한 고급 API를 사용하며 변환기와 추정기로 구성되어 있다.   

**변환기(transformer)**   
데이터 프레임을 입력으로 받아들이고, 하나 이상의 열이 추가된 새 데이터 프레임을 반환한다.   
변환기는 데이터에서 매개변수를 학습하지 않고, 단순히 규칙 기반 변환을 적용하여 모델 훈련을 위한 데이터를 준비하거나 훈련된 MLlib 모델을 사용하여 예측을 생성하며 .transform() 메서드가 있다.   

**추정기(estimator)**   
.fit() 메서드를 통해 데이터 프레임에서 매개변수를 학습하고 변환기인 model을 반환한다.   

**파이프라인**    
일련의 변환기와 추정기를 단일 모델로 구성. 파이프라인 자체가 추정기인 반면, pipeline.fit()의 출력은 변환기인 PipelineModel을 반환한다.   


### 예제   
1. 데이터 수집 및 탐색   
```python
spark = SparkSession.builder \
        .appName('pratice_ml') \
        .config('spark.some.config.option', 'some-value') \
        .getOrCreate()

    filepath = """./code-example/data/sf-airbnb/sf-airbnb-clean.parquet/"""
    airbnbDF = spark.read.parquet(filepath)
    airbnbDF.select("neighbourhood_cleansed", "room_type", "bedrooms", "bathrooms", "number_of_reviews", "price").show(10)
```
**<결과>**   
+----------------------+---------------+--------+---------+-----------------+-----+   
|neighbourhood_cleansed|      room_type|bedrooms|bathrooms|number_of_reviews|price|   
+----------------------+---------------+--------+---------+-----------------+-----+   
|      Western Addition|Entire home/apt|     1.0|      1.0|            180.0|170.0|   
|        Bernal Heights|Entire home/apt|     2.0|      1.0|            111.0|235.0|   
|        Haight Ashbury|   Private room|     1.0|      4.0|             17.0| 65.0|   
|        Haight Ashbury|   Private room|     1.0|      4.0|              8.0| 65.0|   
|      Western Addition|Entire home/apt|     2.0|      1.5|             27.0|785.0|   
|      Western Addition|Entire home/apt|     2.0|      1.0|             31.0|255.0|   
|               Mission|   Private room|     1.0|      1.0|            647.0|139.0|   
|          Potrero Hill|   Private room|     1.0|      1.0|            453.0|135.0|   
|               Mission|Entire home/apt|     2.0|      1.0|            320.0|265.0|   
|        Haight Ashbury|Entire home/apt|     3.0|      1.0|             37.0|177.0|   
+----------------------+---------------+--------+---------+-----------------+-----+   

위 데이터들을 활용하여 임대 부동산의 1박당 가격을 예측해보는 예제를 해보겠다.    

2. 학습 및 테스트 데이터 생성   
피처 엔지니어링 및 모델링을 위해 먼저 데이터 세트를 학습 데이터셋과 테스트 데이터셋으로 나눈다.   
데이터 세트의 크기에 따라 나누는 비율은 다르지만 대다수의 데이터 사이언티스트는 80/20 비율로 나눈다.   
전체 데이터 세트에 대한 모델을 구축하면, 모델이 우리가 제공한 훈련 데이터를 기억하거나 ‘오버피팅’할 수 있기 때문에 구분해서 사용하며 테스트 세트에 대한 모델의 성능은 데이터가 유사한 분포를 따른다고 가정할때, 보지 못한 데이터에서 얼마나 잘 수행되는지에 대한 결과를 확인하기 위함이다.   
(![3E923822-78FC-4A16-9DE3-478435580065.jpeg](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5f23b0b7-4e46-4706-a90f-ed8498e66b4c/3E923822-78FC-4A16-9DE3-478435580065.jpeg))   

에어비앤비 데이터 세트 또한 학습용으로 80%를 유지하고 테스트셋으로 20%를 따로 보관해보겠다.   
또한 재현성을 위해 임의의 시드를 설정해서 각 데이터 세트에서 이동하는 데이터 포인트를 얻어야한다.   
값이 중요하진 않지만 종종 42로 설정하는 것을 좋아하는 분위기가 있다.    

```python
trainDF, testDF = airbnb.randomSplit([.8, .2], seed = 42)
```

**<확인>**   
There are 5780 rows in the training set, and 1366 in the test set   

3. 변환기를 사용하여 기능 준비   
앞서 데이터셋을 훈련 데이터셋과 테스트 데이터셋으로 분할해보았다.   
데이터에서 화장실 수를 기준으로 가격을 예측하는 선형 회귀 모델을 구축해보자.   
선형 회귀에서는 모델에 Input으로 들어갈 데이터가 데이터 프레임의 단일 벡터 내에 포함되어야 하기 때문에 데이터를 변환해줘야 한다.    
먼저 transform() 메서드를 사용해서 규칙 기반 변환을 해주고,
VectorAssembler 변환기로 단일 벡터(단일 열)에 넣어준다.   
```python
vecAssembler = VectorAssembler(
        inputCols=['bathrooms'], outputCol="features")
vecTrainDF = vecAssembler.transform(trainDF)
vecTrainDF.select("bathrooms", "features", "price").show(10)
```
**<결과>**   
+---------+--------+-----+   
|bathrooms|features|price|   
+---------+--------+-----+   
|      1.0|   [1.0]|200.0|   
|      1.0|   [1.0]|130.0|   
|      1.0|   [1.0]| 95.0|   
|      1.0|   [1.0]|250.0|   
|      3.0|   [3.0]|250.0|   
|      1.0|   [1.0]|115.0|   
|      1.5|   [1.5]|105.0|   
|      1.0|   [1.0]| 86.0|   
|      1.0|   [1.0]|100.0|   
|      1.0|   [1.0]|220.0|   
+---------+--------+-----+   
only showing top 10 rows   

3.5 선형 회귀 이해하기   
- 알려진 다른 관련 데이터 값을 사용하여 알 수 없는 데이터의 값을 예측하는 데이터 분석 기법   
- 알 수 없는 변수 또는 종속 변수 = y / 알려진 변수 또는 독립 변수 = x1, x2, x3  / 이 변수들을 선형 방정식, 수학적으로 모델링한다.   
- 예를 들어 단일 기능 x를 가정한다면 **y = mx + b** (m:기울기 b:절편)으로 표현 가능   
- 모든 데이터 포인트가 완벽하게 정렬되지 않으므로 관측 값와 예측 값 간의 차이인 **잔차**를 가지고 잔차의 제곱을 최소화하는 선을 찾는 것이 목적이다.   
- 만약 다중 기능 x_1,  x_2, x_3을 가정한다면 m에 해당하는 weight이 많아진다. 모델에 대한 계수와 절편을 추정하기 위해 매개변수 학습(fitting)을 하는데, 일단 일변량 회귀 먼저 살펴보자.   

4. 추정기를 사용하여 모델 구축   
vectorAssembler 설정 후 데이터가 준비되었다면 추정기를 사용한다. 스파크의 추정기 중 LinearRegression은 데이터 프레임을 사용하고 회귀 모델을 반환한다.   
앞에서 vectorAssembler의 출력이 선형 회귀 모델의 입력 열(features)로 들어가며 추정기는 데이터에서 매개변수 features를 하여 fit() 메서드로 변환기 LinearRegressionModel(lrModel)을 반환한다.
이 변환기는 매개변수르 새 데이터 포인트에 적용하여 예측을 생성한다.

```python
lr = LinearRegression(featuresCol="features", labelCol="price")
    lrModel = lr.fit(vecTrainDF)
    m = round(lrModel.coefficients[0], 2)
    b = round(lrModel.intercept, 2)
    print(f"""The formula for the linear regression line is price = {m}*bathrooms + {b}""")
```

**<결과>**   
The formula for the linear regression line is price = 70.48*bathrooms + 120.59